@inherits LayoutComponentBase
@using AppView.Services
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IApiService ApiService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IToastService ToastService

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <AuthorizeView>
                <Authorized>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <span class="fw-bold">@context.User.FindFirst(ClaimTypes.GivenName)?.Value</span>
                            <small class="d-block text-muted">@context.User.FindFirst(ClaimTypes.Role)?.Value</small>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" @onclick="HandleLogout">
                            <i class="fas fa-sign-out-alt"></i> Đăng xuất
                        </button>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <div class="d-flex align-items-center">
                        <a href="/login" class="btn btn-primary btn-sm me-2">Đăng nhập</a>
                        <a href="/register" class="btn btn-outline-primary btn-sm">Đăng ký</a>
                    </div>
                </NotAuthorized>
            </AuthorizeView>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<!-- Toast Component for global notifications -->
<Toast />

@code {
    private async Task HandleLogout()
    {
        await ApiService.ClearTokenAsync();
        await ApiService.ClearUserInfoAsync();

        if (AuthStateProvider is CustomAuthenticationStateProvider customProvider)
        {
            customProvider.NotifyAuthenticationStateChanged();
        }

        ToastService.ShowInfo("Đăng xuất", "Đã đăng xuất thành công");
        Navigation.NavigateTo("/");
    }
}
